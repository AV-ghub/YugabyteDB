Отлично! Сфокусируемся на **первом варианте ("Нативная" сборка)** и сделаем **сжатое, воспроизводимое руководство**, которое ведет прямо к цели, пропуская тупиковые ветки.

Сначала уточню важный момент по версии: вы правы. Из нашего диалога видно, что мы работали с **PostgreSQL 13.y**, а не 11.2. YugabyteDB 2.18 (на котором мы тестировали) использует код PostgreSQL 13.11. Это критически важный нюанс.

---

### **Анализ стратегии №1: Прямая компиляция PostGIS в среде YugabyteDB ("Нативная" сборка)**

#### **1. Цель и гипотеза**
*   **Цель:** Получить рабочее расширение `postgis` для существующего кластера YugabyteDB путем компиляции непосредственно на целевом сервере.
*   **Гипотеза:** Поскольку YugabyteDB основан на PostgreSQL 13.11, компиляция совместимой версии PostGIS (3.3.x) с правильными зависимостями должна дать библиотеки, которые YugabyteDB сможет загрузить и использовать.

#### **2. Предварительные условия / среда (итоговые)**
*   **ОС:** Rocky Linux 8 (аналогично для CentOS/RHEL 8).
*   **YugabyteDB:** Версия 2.18 (основан на **PostgreSQL 13.11**).
*   **PostGIS:** Исходный код версии **3.3.4** (как максимально совместимая с PG 13.11).
*   **Ключевое понимание:** Необходимо использовать **системные библиотеки из репозиториев ОС**, но **заголовочные файлы (include) PostgreSQL** должны быть от **YugabyteDB**, а не от стандартного postgresql-server.

#### **3. Последовательность ключевых действий (оптимизированный, рабочий путь)**

**(A) Установка зависимостей из репозиториев ОС**
```bash
# Включаем EPEL и PowerTools (CRB) репозитории
sudo dnf install -y epel-release
sudo dnf config-manager --set-enabled powertools

# Устанавливаем компилятор и базовые инструменты сборки
sudo dnf groupinstall -y "Development Tools"
sudo dnf install -y wget git

# Устанавливаем ВСЕ необходимые библиотеки для PostGIS и его зависимостей (GEOS, PROJ, GDAL и т.д.)
sudo dnf install -y \
    geos-devel \
    proj-devel \
    proj-epsg \
    gdal-devel \
    libxml2-devel \
    protobuf-c-devel \
    json-c-devel \
    pcre2-devel \
    libtiff-devel \
    libcurl-devel \
    libtool
```

**(B) Подготовка заголовочных файлов YugabyteDB (критический шаг)**
```bash
# Определяем путь к установленному YugabyteDB (ваш путь может отличаться)
export YB_HOME=/home/yugabyte/yb-software/yugabyte-2.18.1.0
# ИЛИ если YugabyteDB запущен через systemd и находится в стандартном месте:
export YB_HOME=/opt/yugabyte

# Добавляем include-директорию YugabyteDB в переменные компиляции
export C_INCLUDE_PATH=$YB_HOME/postgres/include:$C_INCLUDE_PATH
export CPLUS_INCLUDE_PATH=$YB_HOME/postgres/include:$CPLUS_INCLUDE_PATH
export PATH=$YB_HOME/postgres/bin:$PATH
```

**(C) Скачивание и компиляция PostGIS 3.3.4**
```bash
# Переходим в рабочую директорию
cd /tmp

# Скачиваем исходный код PostGIS 3.3.4 (а не более старые/новые версии)
wget https://download.osgeo.org/postgis/source/postgis-3.3.4.tar.gz
tar -xzvf postgis-3.3.4.tar.gz
cd postgis-3.3.4

# Конфигурация с явным указанием путей к зависимостям и pg_config от YugabyteDB
./configure \
    --with-pgconfig=$YB_HOME/postgres/bin/pg_config \
    --with-geosconfig=/usr/bin/geos-config \
    --with-projdir=/usr \
    --with-gdalconfig=/usr/bin/gdal-config \
    --with-xml2config=/usr/bin/xml2-config

# Компиляция и установка в пользовательскую директорию (не в систему!)
make
sudo make install
```
**Важно:** `make install` установит файлы PostGIS в поддиректории `$YB_HOME/postgres` (библиотеки в `lib/postgresql`, SQL-файлы в `share/postgresql/extension/` и т.д.).

#### **4. Ключевые проблемы и решения (сжато)**

| Проблема | Причина | Решение |
|----------|---------|---------|
| **Ошибка: `pg_config` не найден** | В системе нет pg_config или он от другого PostgreSQL. | Использовать `pg_config` из дистрибутива YugabyteDB, как показано выше. |
| **Ошибка при `./configure`: "PostgreSQL version 13.11 is too old"** | Попытка собрать слишком новую версию PostGIS (например, 3.4.0) для PG 13.11. | Использовать **PostGIS 3.3.4**, который официально поддерживает PostgreSQL 13. |
| **Ошибка линковки: undefined reference to `libprotobuf-c`** | Не установлена библиотека `protobuf-c-devel`. | Убедиться, что пакет `protobuf-c-devel` установлен (см. шаг установки зависимостей). |
| **Ошибка: не найдены заголовочные файлы (`postgres.h`, `fmgr.h`)** | Компилятор ищет их в стандартных путях, а не в директории YB. | Явно задать `C_INCLUDE_PATH` и `CPLUS_INCLUDE_PATH` на директорию `include` YB, как показано выше. |
| **После установки расширение не видно в `CREATE EXTENSION`** | Файлы установились не туда, где их ищет YugabyteDB. | Убедиться, что `pg_config` указывает на YB, тогда `make install` положит файлы в правильные поддиректории `$YB_HOME/postgres`. |

#### **5. Верификация установки**
```bash
# Проверяем, что библиотеки появились
ls -la $YB_HOME/postgres/lib/postgresql/postgis*.so

# Проверяем, что SQL файлы расширения появились
ls -la $YB_HOME/postgres/share/postgresql/extension/postgis*.sql
```

#### **6. Создание и проверка расширения в YugabyteDB**
```sql
-- Подключаемся к YSQL
ysqlsh -U yugabyte -d yugabyte

-- Создаем расширение (должно сработать после успешной компиляции)
CREATE EXTENSION postgis;

-- Проверяем версию PostGIS
SELECT postgis_version();
-- Ожидаемый результат: '3.3.4 ...'
```

#### **7. Итог стратегии**
*   **Результат:** **Частичный успех / Условная работоспособность**.
*   **Что получилось:** Расширение `postgis` создается, базовые функции (например, `PostGIS_Version()`, `ST_GeometryType`) работают.
*   **Ограничения и предостережения:**
    1.  Некоторые функции PostGIS могут работать некорректно или не работать вовсе из-за фундаментальных отличий YugabyteDB от PostgreSQL (распределенная архитектура, отличия в работе индексов и планировщика).
    2.  Данное решение **не поддерживается официально** YugabyteDB.
    3.  Процедуру необходимо повторять при каждой смене версии YugabyteDB или PostGIS.
    4.  Компиляция напрямую на продакшн-сервере — не лучшая практика.

---

**Итог по варианту №1:** Мы получили **рабочий прототип** для тестирования. Это отправная точка, которая доказала принципиальную возможность загрузки PostGIS в YugabyteDB.

**Переходим к разбору стратегии №2 ("Референтная" сборка в изолированной среде)?** Там мы сможем сравнить подходы и выделить более чистый метод получения артефактов.
